---
title: "Análisis de las condiciones favorables para la ocurrencia de incendios en el Perú para los años 2000 -2018"
author: "Contreras y Flores"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
toc: true
toc_depth: 5
fig_caption: true
mainfont: Times New Roman      
---

# Introducción
Los incendios forestales se han convertido en un problema ambiental de gran relevancia y gravedad en las últimas décadas; se presenta a nivel mundial sobre todo en los países con grandes extensiones de áreas forestales (Sabuco, 2013) como es el caso del Perú (FAO, 2004). 
El impacto de los incendios reduce la tasa de crecimiento de los bosques, genera muerte y migración de la fauna silvestre, pérdida de la biodiversidad, trasformación de los suelos e incremento de la erosión, contaminación del aire, reducción de servicios de regulación hídrica del ecosistema, mayor incidencia en derrumbes e inundaciones, incluso la aparición de plagas y enfermedades en los bosques debilitados por dichos incendios. (MINAM, 2019)
En este análisis se evaluará la estacionalidad de las variables bioclimáticas que favorecen a la ocurrencia de incendios.

## 1. Identificación del problema

En los últimos años los incendios han impactado severamente varias regiones del Perú, como Cusco, Lambayeque, Piura y
Cajamarca (INDECI, 2013; El Comercio, 2018) debido en gran parte a que el Perú no está en condiciones para afrontar este tipo de emergencias al no tener una unidad especializada de respuesta ante Incendios (RPP, 2016). 

### 1.1. Planteamiento del problema
### 1.2. Objetivos
#### 1.2.1. Objetivo General
Analizar la estacionalidad de variables bioclimáticas en el marco del estudio de las condiciones favorables para la ocurrencia de incendios (CFOI).

#### 1.2.2. Objetivos Específicos
* Analizar las variables climáticas (calidad de vegatción, temperatura y preciptación) de forma interestacional en las zonas CFOI
* Analizar el comportamiento estacional de las variables bioclimáticas con respecto a la altitud en las zonas CFOI.

### 1.3. Justificación
Las graves consecuencias que a todos los niveles (ecológico, económico, social y humano) pueden derivarse de un incendio forestal son razones suficientes para dedicar una atención especial a este fenómeno. El hombre ha desarrollado numerosos instrumentos y puesto en práctica diversos procedimientos para combatirlos. 
Este proyecto de investigación se justifica en la carencia de datos estadísticos relacionados al registro histórico de
incendios y su distribución espacial, así como su
relación con las condiciones favorables que se
encuentran presentes en el momento de la aparición
del incendio, aspecto que debe ser la base para el
entendimiento de este fenómeno y de la generación
de las políticas de Estado para atenderlo, desde una
óptica de prevención y reducción del riesgo.

## 2. Antecedentes

Desde el año 2017 se han desarrollado presentaciones referidas a los avances en la metodología para determinar las condiciones favorables de incendios. Para el año
2018, se afino la metodología y a mitad de año se inició con los reportes mensuales y posteriormente con los reportes quincenales del registro de incendios, finalizando
el año con el servicio de las Condiciones Favorables de Ocurrrencia de Incendios (CFOI). 

## 3. Marco Teórico

## 4. Área de estudio

## 5. Metodología
Nuestra metodología se resume en cuatro principales etapas, tal y como se describe en la siguiente figura:

```{r echo = FALSE, fig.align='center', comment='Figura 1. Metodología del Trabajo.'}
knitr::include_graphics('Img/metodologia_4etapas.jpg')
=======
```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(sf)
library(rgee)
library(mapedit)
library(raster)
library(tmap)
library(cptcity)
library(leaflet)
library(leaflet.extras)
library(MASS)
library(dplyr)
library(tidyverse)
```

### 5.1 Localización del área de estudio

#### 5.1.1 Histograma de la acumulación de incendios a lo largo del tiempo

```{r}
# Incendios acumulados por mes
shp   <- 'Materiales/registro_incendios_2000_2018.gpkg'
fires <- st_read(shp) %>% 
  mutate(Date = paste(`AñO`, 
                      MES_N, 1, 
                      sep = '-')) %>% 
  group_by(Date) %>% 
  summarise(nfires = length(Date)) %>% 
  mutate(Date = as.Date(Date)) %>%
  arrange(Date) %>% 
  as.data.frame() %>%
  dplyr::select(-geom)
# Como no todos los meses hay incendios se necesita tener todos los meses para generar el histograma
ts    <- data.frame(Date = seq(as.Date('2000-08-01'), 
                               as.Date('2018-12-01'), 
                               by = 'month')) %>% 
  full_join(fires)
ts

# Generación del histograma

X <- ggplot(ts, aes(x=Date, y=nfires)) + 
  geom_bar(stat="identity", 
           fill="gray", 
           colour="black") +
  theme_bw() + 
  ylab(label = 'Número de incendios\n') +  
  xlab(label = '') + 
  ggtitle(paste('Eventos de incendios \ndel año 2000 al 2018', sep = '')) +
  theme(plot.title = element_text(hjust = 0.5, face = 'bold', size=15),
        axis.text.x  = element_text(size=11, angle = 75, hjust = 1),
        axis.text.y  = element_text(size=11),
        axis.title.y = element_text(size = 12, hjust = 0.5, face = 'bold', vjust = 0.5)) + 
  scale_x_date(limits = c(as.Date('2000-07-01'),
                          as.Date('2019-01-01')),
               date_labels = ("%Y"), 
               breaks = '1 year') +
  scale_y_continuous(breaks = seq(0,500,50))
X
```


#### 5.1.2 Estimación de densidad de probabilidad 2D

Se estima la función de densidad de probabilidad para calcular en porcentaje la posibilidad de ocurrencia de incendios para cada pixel, clusterizando las regiones con mayor probabilidad por sobre un umbral definido, además se muestra la región a partir de la cual se basará nuestros graficos de análisis posteriores

```{r}
fires <- st_read(shp)
peru <- read_sf('Materiales/Peru.gpkg')
Departamentos <- st_read('Materiales/Departamentos.gpkg')

# Extracción de coordenadas de los puntos
fires_df <- st_coordinates(fires) %>% as.data.frame()
names(fires_df) <- c('lon','lat')#here

# Aplicación de la estimación
kde <- kde2d(fires_df$lon, fires_df$lat, n = 250, h = .5, lims = c(-86, -65, -19, 0))
kde_raster <- kde %>% raster() %>% crop(peru) %>% mask(peru)

# image(kde)
# plot(peru, add = T, col = NA)

# Convirtiendolo a raster:
# 
# kde_raster <- kde %>% raster()
# kde_raster[kde_raster < 0.05] = NA
# kde_raster[kde_raster >= 0.05] = 1
# writeRaster(kde_raster, 'raster2.tif')

# summary(kde_raster %>% getValues() %>% as_vector())
# Mapa con leaflet
# pal <- colorNumeric(c("#0C2C84", "#41B6C4", "#FFFFCC"), values(kde_raster ), na.color = "transparent")


pal <- colorNumeric(c("#3182bd", "#fec44f", "#f03b20"), values(kde_raster), na.color ="transparent")
                   

leaflet() %>%
  addTiles() %>%
  addRasterImage(kde_raster, colors = pal) %>%
  addLegend(pal = pal, values = values(kde_raster),title = "% Incendios") %>%
  addPolygons(data = Departamentos,
              fillOpacity = 0,
              weight = 2,
              opacity = 1,
              label = ~DEPARTAMEN,
              color = "#000000",
              group = "Departamentos")
```

#### 5.1.2 Elección del área de estudio

```{r}
Provincias <- st_read('Materiales/Provincias.gpkg')
Anta <- st_read('Materiales/Anta.gpkg')
names(Provincias)
kde_raster_clas <- kde_raster
kde_raster_clas[kde_raster < 0.05] = NA
kde_raster_clas[kde_raster >= 0.05] = 1
# writeRaster(kde_raster, 'raster2.tif')


leaflet() %>%
  addTiles() %>%
  addRasterImage(kde_raster_clas, colors = "#f03b20") %>%
  # addLegend(pal = pal, values = values(kde_raster),title = "% Incendios") %>%
  addPolygons(data = Provincias,
              fillOpacity = 0,
              weight = 2,
              opacity = 1,
              label = ~PROVINCIA,
              color = "#000000",
              group = "Provincias") %>%
  addPolygons(data = Anta,
              fillOpacity = 0,
              weight = 4,
              opacity = 1,
              label = ~PROVINCIA,
              color = "#54278f",
              group = "Anta")
```


### 5.1 Materiales

#### 5.1.1 Data histórica de incendios 2000-2018
Este registro abarca los años 2000 a 2018, descargados del [geoservidor del Ministerio del Ambiente (MINAM)](https://geoservidor.minam.gob.pe/monitoreo-y-evaluacion/registros-historicos-cfoi/).

#### 5.1.2 Precipitación acumulada y Temperatura Máxima
Este se obtendrá del producto grillado PISCO, del Servicio Nacional de Meteorología e Hidrología (SENHAMI)

#### 5.1.3 Índice de Vegetación Normalizado (NDVI)
Este se obtendrá del producto del sensor MODIS (MOD13Q1), 2000 - 2018.

## 6. Resultados

## 7. Análisis 

## 8. Discusión de resultados

## 9. Conclusión

## 10. Referencias


