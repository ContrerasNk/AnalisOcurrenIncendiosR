---
title: "Análisis de las condiciones favorables para la ocurrencia de incendios en el Perú para los años 2000 -2019"
author: "Contreras y Flores"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
toc: true
toc_depth: 5
fig_caption: true
mainfont: Times New Roman      
---

# Introducción
Los incendios forestales se han convertido en un problema ambiental de gran relevancia y gravedad en las últimas décadas; se presenta a nivel mundial sobre todo en los países con grandes extensiones de áreas forestales (Sabuco, 2013). Se estima que cada año se producen entre 60 000 y 80 000 incendios forestales, los cuales tienen una gran capacidad destructiva, ya que devastan entre 3 y 10 millones de hectáreas (Bisbal, 2019). En este análisis se evaluará el comportamiento del registro de incendios, así como las variables que condicionan su propagación.

## 1. Identificación del problema

El Perú es un País con una gran biodiversidad, presenta más de un 75% del total del planeta con este potencial, posee una gran extensión del recurso forestal, ubicándose en el segundo lugar, a nivel de Sudamérica en bosques naturales, y noveno lugar a nivel mundial. (FAO, 2004). De acuerdo a la clasificación de tierras, por su capacidad de uso mayor se tiene al recurso forestal y pastos ocupando la mayor extensión del territorio nacional; el recurso forestal está formado por tierras de producción forestal y tierras de protección donde las tierras de producción están cubiertas de bosques generalmente heterogéneos dedicados a la producción permanente de madera y otros productos forestales y las tierras de protección en la mayoría de casos se encuentran en terrenos montañosos, con pendientes moderadamente empinadas a altas.


### 1.1. Planteamiento del problema
### 1.2. Objetivo Principal
Generar una metodología para el análisis predictivo de los incendios forestales sobre la cobertura vegetal, a través del análisis de variables que condicionan las características físicas y meteorológicas del territorio nacional. 

Analizar la estacionalidad de variables bioclimáticas en el marco del estudio de las condiciones favorables para la ocurrencia de incendios (CFOI).

#### 1.2.1. Objetivo General

#### 1.2.2. Objetivos Específicos
### 1.3. Justificación

## 2. Antecedentes

## 3. Marco Teórico

## 4. Área de estudio

## 5. Metodología
```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(sf)
library(rgee)
library(mapedit)
library(raster)
library(tmap)
library(cptcity)
library(leaflet)
library(leaflet.extras)
library(MASS)
library(dplyr)
library(tidyverse)
```

### 5.1 Localización del área de estudio

#### 5.1.1 Histograma de la acumulación de incendios a lo largo del tiempo

```{r}
# Incendios acumulados por mes
shp   <- 'Materiales/registro_incendios_2000_2018.gpkg'
fires <- st_read(shp) %>% 
  mutate(Date = paste(`AñO`, 
                      MES_N, 1, 
                      sep = '-')) %>% 
  group_by(Date) %>% 
  summarise(nfires = length(Date)) %>% 
  mutate(Date = as.Date(Date)) %>%
  arrange(Date) %>% 
  as.data.frame() %>%
  dplyr::select(-geom)
# Como no todos los meses hay incendios se necesita tener todos los meses para generar el histograma
ts    <- data.frame(Date = seq(as.Date('2000-08-01'), 
                               as.Date('2018-12-01'), 
                               by = 'month')) %>% 
  full_join(fires)
ts

# Generación del histograma

X <- ggplot(ts, aes(x=Date, y=nfires)) + 
  geom_bar(stat="identity", 
           fill="gray", 
           colour="black") +
  theme_bw() + 
  ylab(label = 'Número de incendios\n') +  
  xlab(label = '') + 
  ggtitle(paste('Eventos de incendios \ndel año 2000 al 2018', sep = '')) +
  theme(plot.title = element_text(hjust = 0.5, face = 'bold', size=15),
        axis.text.x  = element_text(size=11, angle = 75, hjust = 1),
        axis.text.y  = element_text(size=11),
        axis.title.y = element_text(size = 12, hjust = 0.5, face = 'bold', vjust = 0.5)) + 
  scale_x_date(limits = c(as.Date('2000-07-01'),
                          as.Date('2019-01-01')),
               date_labels = ("%Y"), 
               breaks = '1 year') +
  scale_y_continuous(breaks = seq(0,500,50))
X
```


#### 5.1.2 Estimación de densidad de probabilidad 2D

Se estima la función de densidad de probabilidad para calcular en porcentaje la posibilidad de ocurrencia de incendios para cada pixel, clusterizando las regiones con mayor probabilidad por sobre un umbral definido, además se muestra la región a partir de la cual se basará nuestros graficos de análisis posteriores

```{r}
fires <- st_read(shp)
peru <- read_sf('Materiales/Peru.gpkg')
Departamentos <- st_read('Materiales/Departamentos.gpkg')

# Extracción de coordenadas de los puntos
fires_df <- st_coordinates(fires) %>% as.data.frame()
names(fires_df) <- c('lon','lat')#here

# Aplicación de la estimación
kde <- kde2d(fires_df$lon, fires_df$lat, n = 250, h = .5, lims = c(-86, -65, -19, 0))
kde_raster <- kde %>% raster() %>% crop(peru) %>% mask(peru)

# image(kde)
# plot(peru, add = T, col = NA)

# Convirtiendolo a raster:
# 
# kde_raster <- kde %>% raster()
# kde_raster[kde_raster < 0.05] = NA
# kde_raster[kde_raster >= 0.05] = 1
# writeRaster(kde_raster, 'raster2.tif')

# summary(kde_raster %>% getValues() %>% as_vector())
# Mapa con leaflet
# pal <- colorNumeric(c("#0C2C84", "#41B6C4", "#FFFFCC"), values(kde_raster ), na.color = "transparent")


pal <- colorNumeric(c("#3182bd", "#fec44f", "#f03b20"), values(kde_raster), na.color ="transparent")
                   

leaflet() %>%
  addTiles() %>%
  addRasterImage(kde_raster, colors = pal) %>%
  addLegend(pal = pal, values = values(kde_raster),title = "% Incendios") %>%
  addPolygons(data = Departamentos,
              fillOpacity = 0,
              weight = 2,
              opacity = 1,
              label = ~DEPARTAMEN,
              color = "#000000",
              group = "Departamentos")
```

#### 5.1.2 Elección del área de estudio



```{r}
Provincias <- st_read('Materiales/Provincias.gpkg')
Anta <- st_read('Materiales/Anta.gpkg')
names(Provincias)
kde_raster_clas <- kde_raster
kde_raster_clas[kde_raster < 0.05] = NA
kde_raster_clas[kde_raster >= 0.05] = 1
# writeRaster(kde_raster, 'raster2.tif')


leaflet() %>%
  addTiles() %>%
  addRasterImage(kde_raster_clas, colors = "#f03b20") %>%
  # addLegend(pal = pal, values = values(kde_raster),title = "% Incendios") %>%
  addPolygons(data = Provincias,
              fillOpacity = 0,
              weight = 2,
              opacity = 1,
              label = ~PROVINCIA,
              color = "#000000",
              group = "Provincias") %>%
  addPolygons(data = Anta,
              fillOpacity = 0,
              weight = 4,
              opacity = 1,
              label = ~PROVINCIA,
              color = "#54278f",
              group = "Anta")
```

### 5.1 Datos a utilizar

#### 5.1.1 Registro de incendios
Este registro abarca los años 2000 a 2019, descargados desde el geoservidor del Ministerio del Ambiente (MINAM).

#### 5.1.2 Precipitación y Temperatura Máxima
Este se obtendrá del producto grillado PISCO, del Servicio Nacional de Meteorología e Hidrología (SENHAMI)

#### 5.1.3 Producto NDVI
Este se obtendrá del producto del sensor MODIS (MOD13Q1), 2000 - 2019
## 6. Resultados

## 7. Análisis 

## 8. Discusión de resultados

## 9. Conclusión

## 10. Referencias


